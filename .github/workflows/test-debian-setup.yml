name: Test debian-setup.sh

on:
  push:
    paths:
      - 'linux/mint/debian-setup.sh'
      - 'linux/mint/versions.conf'
      - '.github/workflows/test-debian-setup.yml'
  pull_request:
    paths:
      - 'linux/mint/debian-setup.sh'
      - 'linux/mint/versions.conf'
      - '.github/workflows/test-debian-setup.yml'
  workflow_dispatch: {}

jobs:
  lint:
    name: Shell lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        env:
          SHELLCHECK_OPTS: -x -P linux/mint -P ci-stubs
        with:
          scandir: .

  install-and-verify:
    name: Install and verify on Debian
    runs-on: ubuntu-latest
    container:
      image: debian:12-slim
      options: --init
    defaults:
      run:
        shell: bash
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: UTC
      # Update this if your versions file lives elsewhere
      VERSIONS_FILE: linux/mint/versions.conf
      SCRIPT: linux/mint/debian-setup.sh
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Preflight packages for CI
        run: |
          set -euxo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl git sudo bash coreutils grep sed gawk \
            xz-utils tar gzip procps
          update-ca-certificates

      - name: Bash syntax check
        run: bash -n "$SCRIPT"

      - name: First run
        run: |
          set -euxo pipefail
          bash -lx "$SCRIPT" 2>&1 | tee first-run.log

      - name: Second run (idempotency)
        run: |
          set -euxo pipefail
          bash -lx "$SCRIPT" 2>&1 | tee second-run.log

      - name: Verify installed versions match versions.conf
        shell: bash
        run: |
          set -euo pipefail

          VCONF="${VERSIONS_FILE}"
          test -f "$VCONF" || { echo "versions file not found: $VCONF"; exit 1; }

          want() { grep -E "^$1=" "$VCONF" | head -n1 | cut -d= -f2- | tr -d ' \t'; }

          WANT_GO="$(want GO_VERSION)"
          WANT_NODE="$(want NODE_VERSION)"
          WANT_NVIM="$(want NEOVIM_VERSION)"
          WANT_NVM="$(want NVM_VERSION)"
          WANT_JAVA="$(want JAVA_VERSION)"

          echo "Expected versions from $VCONF:"
          printf '  GO=%s\n  NODE=%s\n  NEOVIM=%s\n  NVM=%s\n  JAVA=%s\n' \
            "$WANT_GO" "$WANT_NODE" "$WANT_NVIM" "$WANT_NVM" "$WANT_JAVA"

          # Go
          GO_VER="$(go version 2>/dev/null | awk '{print $3}' | sed 's/^go//')"
          [[ "$GO_VER" == "$WANT_GO"* ]] || { echo "Go mismatch: have $GO_VER want $WANT_GO"; exit 1; }

          # NVM (may need sourcing)
          if [ -s "$HOME/.nvm/nvm.sh" ]; then
            # shellcheck source=/dev/null
            . "$HOME/.nvm/nvm.sh"
          fi
          NVM_VER_RAW="$(command -v nvm >/dev/null 2>&1 && nvm --version || true)"
          NVM_VER="$(printf '%s' "$NVM_VER_RAW" | sed 's/^v//')"
          WANT_NVM_STRIPPED="$(printf '%s' "$WANT_NVM" | sed 's/^v//')"
          [ -n "$NVM_VER" ] || { echo "nvm not available in PATH"; exit 1; }
          [[ "$NVM_VER" == "$WANT_NVM_STRIPPED"* ]] || { echo "NVM mismatch: have $NVM_VER want $WANT_NVM"; exit 1; }

          # Java (managed via SDKMAN)
          if [ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]; then
            # shellcheck source=/dev/null
            . "$HOME/.sdkman/bin/sdkman-init.sh"
          fi

          JAVA_VER_LABEL=""
          if command -v sdk >/dev/null 2>&1; then
            SDK_CURRENT_JAVA_OUTPUT="$(sdk current java 2>/dev/null || true)"
            JAVA_VER_LABEL="$(printf '%s\n' "$SDK_CURRENT_JAVA_OUTPUT" | awk 'NF{print $NF; exit}')"
          fi
          if [ -z "$JAVA_VER_LABEL" ] && command -v java >/dev/null 2>&1; then
            JAVA_VER_LABEL="$(java -version 2>&1 | head -n1)"
          fi

          [ -n "$JAVA_VER_LABEL" ] || { echo "Unable to determine active Java version"; exit 1; }

          WANT_JAVA_MAJOR="${WANT_JAVA%%[^0-9]*}"
          if [ -z "$WANT_JAVA_MAJOR" ]; then
            WANT_JAVA_MAJOR="$WANT_JAVA"
          fi

          case "$JAVA_VER_LABEL" in
            *"$WANT_JAVA_MAJOR"*) ;;
            *)
              echo "Java mismatch: have $JAVA_VER_LABEL want major $WANT_JAVA_MAJOR (from $WANT_JAVA)"
              exit 1
              ;;
          esac

          # Node (if installed via nvm, ensure it's the default shell has it)
          if ! command -v node >/dev/null 2>&1 && [ -s "$HOME/.nvm/nvm.sh" ]; then
            . "$HOME/.nvm/nvm.sh"
          fi
          NODE_VER_RAW="$(node -v 2>/dev/null || true)"
          NODE_VER="$(printf '%s' "$NODE_VER_RAW" | sed 's/^v//')"
          WANT_NODE_STRIPPED="$(printf '%s' "$WANT_NODE" | sed 's/^v//')"
          [ -n "$NODE_VER" ] || { echo "node not available in PATH"; exit 1; }
          [[ "$NODE_VER" == "$WANT_NODE_STRIPPED"* ]] || { echo "Node mismatch: have $NODE_VER want $WANT_NODE"; exit 1; }

          # Neovim
          NVIM_VER_RAW="$(nvim --version 2>/dev/null | head -n1 | awk '{print $2}')"
          NVIM_VER="$(printf '%s' "$NVIM_VER_RAW" | sed 's/^v//')"
          WANT_NVIM_STRIPPED="$(printf '%s' "$WANT_NVIM" | sed 's/^v//')"
          [ -n "$NVIM_VER" ] || { echo "nvim not available in PATH"; exit 1; }
          [[ "$NVIM_VER" == "$WANT_NVIM_STRIPPED"* ]] || { echo "Neovim mismatch: have $NVIM_VER want $WANT_NVIM"; exit 1; }

          echo "All version checks passed."

      - name: Upload logs
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: debian-setup-logs
          path: |
            first-run.log
            second-run.log

