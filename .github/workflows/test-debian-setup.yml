name: Test debian-setup.sh

on:
  push:
    paths:
      - 'linux/mint/debian-setup.sh'
      - 'linux/mint/versions.conf'
      - '.github/workflows/test-debian-setup.yml'
  pull_request:
    paths:
      - 'linux/mint/debian-setup.sh'
      - 'linux/mint/versions.conf'
      - '.github/workflows/test-debian-setup.yml'
  workflow_dispatch: {}

jobs:
  lint:
    name: Shell lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        env:
          SHELLCHECK_OPTS: -x -P linux/mint -P ci-stubs
        with:
          scandir: .

  install-and-verify:
    name: Install and verify on Debian
    runs-on: ubuntu-latest
    container:
      image: debian:12-slim
      options: --init
    defaults:
      run:
        shell: bash
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: UTC
      # Update this if your versions file lives elsewhere
      VERSIONS_FILE: linux/mint/versions.conf
      SCRIPT: linux/mint/debian-setup.sh
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Preflight packages for CI
        run: |
          set -euxo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl git sudo bash coreutils grep sed gawk \
            xz-utils tar gzip procps
          update-ca-certificates

      - name: Bash syntax check
        run: bash -n "$SCRIPT"

      - name: First run
        run: |
          set -euxo pipefail
          bash -lx "$SCRIPT" 2>&1 | tee first-run.log

      - name: Second run (idempotency)
        run: |
          set -euxo pipefail
          bash -lx "$SCRIPT" 2>&1 | tee second-run.log

      - name: Upload logs
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: debian-setup-logs
          path: |
            first-run.log
            second-run.log

