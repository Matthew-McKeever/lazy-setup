name: Test debian-setup.sh

on:
  push:
    paths:
      - 'linux/mint/debian-setup.sh'
      - 'linux/mint/versions.conf'
      - '.github/workflows/test-debian-setup.yml'
  pull_request:
    paths:
      - 'linux/mint/debian-setup.sh'
      - 'linux/mint/versions.conf'
      - '.github/workflows/test-debian-setup.yml'
  workflow_dispatch: {}

jobs:
  lint:
    name: Shell lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        env:
          SHELLCHECK_OPTS: -x -P linux/mint -P ci-stubs
        with:
          scandir: .

  install-and-verify:
    name: Install and verify on Debian
    runs-on: ubuntu-latest
    container:
      image: debian:12-slim
      options: --init
    defaults:
      run:
        shell: bash
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: UTC
      # Update this if your versions file lives elsewhere
      VERSIONS_FILE: linux/mint/versions.conf
      SCRIPT: linux/mint/debian-setup.sh
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Preflight packages for CI
        run: |
          set -euxo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl git sudo bash coreutils grep sed gawk \
            xz-utils tar gzip procps
          update-ca-certificates

      - name: Bash syntax check
        run: bash -n "$SCRIPT"

      - name: First run
        run: |
          set -euxo pipefail
          bash -lx "$SCRIPT" 2>&1 | tee first-run.log

      - name: Second run (idempotency)
        run: |
          set -euxo pipefail
          bash -lx "$SCRIPT" 2>&1 | tee second-run.log

      - name: Verify installed versions match versions.conf
        shell: bash
        run: |
          set -euo pipefail

          VCONF="${VERSIONS_FILE}"
          test -f "$VCONF" || { echo "versions file not found: $VCONF"; exit 1; }

          want() { grep -E "^$1=" "$VCONF" | head -n1 | cut -d= -f2- | tr -d ' \t'; }

          WANT_GO="$(want GO_VERSION)"
          WANT_NODE="$(want NODE_VERSION)"
          WANT_NVIM="$(want NEOVIM_VERSION)"
          WANT_NVM="$(want NVM_VERSION)"
          WANT_JAVA="$(want JAVA_VERSION)"

          declare -A EXPECTED=()
          EXPECTED[GO]="$WANT_GO"
          EXPECTED[NODE]="$WANT_NODE"
          EXPECTED[NEOVIM]="$WANT_NVIM"
          EXPECTED[NVM]="$WANT_NVM"
          EXPECTED[JAVA]="$WANT_JAVA"

          declare -A ACTUAL=()
          declare -a MISMATCHES=()
          TOOL_ORDER=(GO NODE NEOVIM NVM JAVA)

          # Go
          GO_VER="$(go version 2>/dev/null | awk '{print $3}' | sed 's/^go//')"
          if [ -z "$GO_VER" ]; then
            GO_VER="(not found)"
            MISMATCHES+=("Go not installed")
          elif [[ "$GO_VER" != "$WANT_GO"* ]]; then
            MISMATCHES+=("Go mismatch: have $GO_VER want $WANT_GO")
          fi
          ACTUAL[GO]="$GO_VER"

          # NVM (may need sourcing)
          if [ -s "$HOME/.nvm/nvm.sh" ]; then
            # shellcheck source=/dev/null
            . "$HOME/.nvm/nvm.sh"
          fi
          NVM_VER_RAW="$(command -v nvm >/dev/null 2>&1 && nvm --version || true)"
          NVM_VER="$(printf '%s' "$NVM_VER_RAW" | sed 's/^v//')"
          WANT_NVM_STRIPPED="$(printf '%s' "$WANT_NVM" | sed 's/^v//')"
          if [ -z "$NVM_VER" ]; then
            NVM_VER="(not found)"
            MISMATCHES+=("nvm not available in PATH")
          elif [[ "$NVM_VER" != "$WANT_NVM_STRIPPED"* ]]; then
            MISMATCHES+=("NVM mismatch: have $NVM_VER want $WANT_NVM")
          fi
          ACTUAL[NVM]="$NVM_VER"

          # Java (managed via SDKMAN)
          if [ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]; then
            # shellcheck source=/dev/null
            . "$HOME/.sdkman/bin/sdkman-init.sh"
          fi

          JAVA_VER_LABEL=""
          if command -v sdk >/dev/null 2>&1; then
            SDK_CURRENT_JAVA_OUTPUT="$(sdk current java 2>/dev/null || true)"
            JAVA_VER_LABEL="$(printf '%s\n' "$SDK_CURRENT_JAVA_OUTPUT" | awk 'NF{print $NF; exit}')"
          fi
          if [ -z "$JAVA_VER_LABEL" ] && command -v java >/dev/null 2>&1; then
            JAVA_VER_LABEL="$(java -version 2>&1 | head -n1)"
          fi

          if [ -z "$JAVA_VER_LABEL" ]; then
            JAVA_VER_LABEL="(not found)"
            MISMATCHES+=("Unable to determine active Java version")
          fi

          WANT_JAVA_MAJOR="${WANT_JAVA%%[^0-9]*}"
          if [ -z "$WANT_JAVA_MAJOR" ]; then
            WANT_JAVA_MAJOR="$WANT_JAVA"
          fi

          if [ "$JAVA_VER_LABEL" != "(not found)" ]; then
            case "$JAVA_VER_LABEL" in
              *"$WANT_JAVA_MAJOR"*) ;;
              *)
                MISMATCHES+=("Java mismatch: have $JAVA_VER_LABEL want major $WANT_JAVA_MAJOR (from $WANT_JAVA)")
                ;;
            esac
          fi
          ACTUAL[JAVA]="$JAVA_VER_LABEL"

          # Node (if installed via nvm, ensure it's the default shell has it)
          if ! command -v node >/dev/null 2>&1 && [ -s "$HOME/.nvm/nvm.sh" ]; then
            . "$HOME/.nvm/nvm.sh"
          fi
          NODE_VER_RAW="$(node -v 2>/dev/null || true)"
          NODE_VER="$(printf '%s' "$NODE_VER_RAW" | sed 's/^v//')"
          WANT_NODE_STRIPPED="$(printf '%s' "$WANT_NODE" | sed 's/^v//')"
          if [ -z "$NODE_VER" ]; then
            NODE_VER="(not found)"
            MISMATCHES+=("node not available in PATH")
          elif [[ "$NODE_VER" != "$WANT_NODE_STRIPPED"* ]]; then
            MISMATCHES+=("Node mismatch: have $NODE_VER want $WANT_NODE")
          fi
          ACTUAL[NODE]="$NODE_VER"

          # Neovim
          NVIM_VER_RAW="$(nvim --version 2>/dev/null | head -n1 | awk '{print $2}')"
          NVIM_VER="$(printf '%s' "$NVIM_VER_RAW" | sed 's/^v//')"
          WANT_NVIM_STRIPPED="$(printf '%s' "$WANT_NVIM" | sed 's/^v//')"
          if [ -z "$NVIM_VER" ]; then
            NVIM_VER="(not found)"
            MISMATCHES+=("nvim not available in PATH")
          elif [[ "$NVIM_VER" != "$WANT_NVIM_STRIPPED"* ]]; then
            MISMATCHES+=("Neovim mismatch: have $NVIM_VER want $WANT_NVIM")
          fi
          ACTUAL[NEOVIM]="$NVIM_VER"

          echo "Installed versions summary:"
          for tool in "${TOOL_ORDER[@]}"; do
            printf '  %s: have %s (expected %s)\n' \
              "$tool" "${ACTUAL[$tool]:-(not checked)}" "${EXPECTED[$tool]:-unknown}"
          done

          if [ "${#MISMATCHES[@]}" -gt 0 ]; then
            echo "Version mismatches detected:"
            for msg in "${MISMATCHES[@]}"; do
              printf '  - %s\n' "$msg"
            done
            exit 1
          fi

          echo "All version checks passed."

      - name: Upload logs
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: debian-setup-logs
          path: |
            first-run.log
            second-run.log

